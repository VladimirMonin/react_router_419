# 🛒 Гибридная корзина и оформление заказов в React

## 📋 Содержание
1. [Глобальная задача](#глобальная-задача)
2. [Архитектура решения](#архитектура-решения)
3. [Коммит №1: API слой](#коммит-1-api-слой)
4. [Коммит №2: Гибридная логика корзины](#коммит-2-гибридная-логика-корзины)
5. [Коммит №3: Синхронизация при входе](#коммит-3-синхронизация-при-входе)
6. [Коммит №4: Оформление заказа](#коммит-4-оформление-заказа)
7. [Коммит №5: История заказов](#коммит-5-история-заказов)
8. [Итоговая архитектура](#итоговая-архитектура)

---

## Глобальная задача

### 🎯 Что мы строим?

Превращаем React-приложение из **"витрины с локальной корзиной"** в **полноценный e-commerce клиент**:

```
┌─────────────────────────────────────────────────────────────────┐
│                        ДО (было)                                │
├─────────────────────────────────────────────────────────────────┤
│  👤 Гость                          👤 Авторизованный            │
│     │                                   │                       │
│     ▼                                   ▼                       │
│  🛒 Корзина в памяти              🛒 Та же корзина в памяти    │
│     │                                   │                       │
│     ▼                                   ▼                       │
│  ❌ Закрыл вкладку = потерял      ❌ Закрыл = потерял          │
│  ❌ Нет заказов                   ❌ Нет заказов               │
└─────────────────────────────────────────────────────────────────┘

                              ⬇️ РЕФАКТОРИНГ ⬇️

┌─────────────────────────────────────────────────────────────────┐
│                       ПОСЛЕ (стало)                             │
├─────────────────────────────────────────────────────────────────┤
│  👤 Гость                          👤 Авторизованный            │
│     │                                   │                       │
│     ▼                                   ▼                       │
│  💾 localStorage                   ☁️ Сервер (PostgreSQL)       │
│     │                                   │                       │
│     ├── Сохраняется между сессиями      ├── Доступ с любого     │
│     │                                   │   устройства          │
│     └── При логине → merge на сервер    │                       │
│                                         ├── Оформление заказов  │
│                                         └── История покупок     │
└─────────────────────────────────────────────────────────────────┘
```

### 🧩 Ключевые концепции

| Концепция | Описание | Зачем нужна |
|-----------|----------|-------------|
| **Гибридное хранилище** | Автоматический выбор: localStorage или API | Пользователь не думает о технических деталях |
| **Merge при логине** | Слияние локальной и серверной корзины | Гость не теряет товары после авторизации |
| **Frozen Price** | Фиксация цены в момент заказа | Защита от изменения цен после покупки |
| **Оптимистичный UI** | Мгновенное обновление интерфейса | Быстрый отклик, даже если API медленный |

---

## Архитектура решения

### 🏗️ Слоёная архитектура

```
┌──────────────────────────────────────────────────────────────┐
│                    КОМПОНЕНТЫ (UI)                           │
│  ┌──────────┐  ┌──────────┐  ┌──────────┐  ┌──────────────┐  │
│  │CartPage  │  │ProductCard│  │LoginPage │  │ ProfilePage  │  │
│  └────┬─────┘  └────┬─────┘  └────┬─────┘  └──────┬───────┘  │
│       │             │             │               │          │
└───────┼─────────────┼─────────────┼───────────────┼──────────┘
        │             │             │               │
        ▼             ▼             ▼               ▼
┌──────────────────────────────────────────────────────────────┐
│                         ХУКИ                                 │
│  ┌─────────────────────────────────────────────────────────┐ │
│  │                      useCart                            │ │
│  │  ┌─────────────┐         ┌─────────────────────────┐    │ │
│  │  │ user есть?  │───Да───▶│ Работаем с cartApi      │    │ │
│  │  └──────┬──────┘         └─────────────────────────┘    │ │
│  │         │ Нет                                           │ │
│  │         ▼                                               │ │
│  │  ┌─────────────────────────────────────────────┐        │ │
│  │  │ Работаем с localStorage                     │        │ │
│  │  └─────────────────────────────────────────────┘        │ │
│  └─────────────────────────────────────────────────────────┘ │
│                                                              │
│  ┌──────────────┐                                            │
│  │   useAuth    │ ◀── Предоставляет user и token             │
│  └──────────────┘                                            │
└──────────────────────────────────────────────────────────────┘
        │
        ▼
┌──────────────────────────────────────────────────────────────┐
│                      API СЛОЙ                                │
│  ┌──────────────┐  ┌──────────────┐  ┌──────────────┐        │
│  │   cartApi    │  │  ordersApi   │  │   authApi    │        │
│  │  • get()     │  │  • create()  │  │  • login()   │        │
│  │  • addItem() │  │  • getAll()  │  │  • register()│        │
│  │  • merge()   │  │  • getById() │  │  • getProfile│        │
│  └──────────────┘  └──────────────┘  └──────────────┘        │
└──────────────────────────────────────────────────────────────┘
        │
        ▼
┌──────────────────────────────────────────────────────────────┐
│                    FastAPI Backend                           │
│              (PostgreSQL + SQLAlchemy)                       │
└──────────────────────────────────────────────────────────────┘
```

### 🔄 Жизненный цикл корзины

```
                    ┌─────────────────┐
                    │  Пользователь   │
                    │  открывает сайт │
                    └────────┬────────┘
                             │
                             ▼
                    ┌─────────────────┐
                    │  useCart        │
                    │  инициализация  │
                    └────────┬────────┘
                             │
              ┌──────────────┴──────────────┐
              │                             │
              ▼                             ▼
     ┌─────────────────┐          ┌─────────────────┐
     │  user === null  │          │  user !== null  │
     │  (Гость)        │          │  (Авторизован)  │
     └────────┬────────┘          └────────┬────────┘
              │                             │
              ▼                             ▼
     ┌─────────────────┐          ┌─────────────────┐
     │ loadFromLocal   │          │ cartApi.get()   │
     │ Storage()       │          │                 │
     └────────┬────────┘          └────────┬────────┘
              │                             │
              ▼                             ▼
     ┌─────────────────┐          ┌─────────────────┐
     │ Товары из       │          │ Товары с        │
     │ localStorage    │          │ сервера         │
     └─────────────────┘          └─────────────────┘
              │                             │
              └──────────────┬──────────────┘
                             │
                             ▼
                    ┌─────────────────┐
                    │  setItems(...)  │
                    │  UI обновлён    │
                    └─────────────────┘
```

---

## Коммит 1: API слой

### 🎯 Цель
Подготовить "фундамент" — научить фронтенд "говорить" с новыми эндпоинтами бэкенда.

### 📁 Файлы
- `src/types/api.ts` — типы данных
- `src/services/api.ts` — методы API

### 🧱 Новые типы данных

#### ServerCartItem — позиция в корзине на сервере

```
┌─────────────────────────────────────────────────────────┐
│                   ServerCartItem                        │
├─────────────────────────────────────────────────────────┤
│  id: number          ◀── ID позиции в БД               │
│  product_id: number  ◀── Ссылка на товар               │
│  quantity: number    ◀── Количество                    │
│  product: Product    ◀── Вложенный объект товара       │
└─────────────────────────────────────────────────────────┘
```

> 💡 **Почему `product` вложенный?**  
> Сервер сразу отдаёт полные данные товара, чтобы не делать дополнительные запросы.
> Это паттерн **"Eager Loading"** — загрузка связанных данных заранее.

#### Cart — корзина целиком

```
┌─────────────────────────────────────────────────────────┐
│                        Cart                             │
├─────────────────────────────────────────────────────────┤
│  id: number                  ◀── ID корзины            │
│  items: ServerCartItem[]     ◀── Массив позиций        │
│  total_price: number         ◀── Сумма (считает сервер)│
└─────────────────────────────────────────────────────────┘
```

> 💡 **Почему сервер считает total_price?**  
> Единый источник правды. Если клиент сам считает — могут быть расхождения
> из-за округлений или багов. Сервер гарантирует корректность.

#### Order — заказ

```
┌─────────────────────────────────────────────────────────┐
│                        Order                            │
├─────────────────────────────────────────────────────────┤
│  id: number                                             │
│  status: 'pending' | 'confirmed' | 'shipped' | ...      │
│  total_amount: number        ◀── Зафиксированная сумма │
│  created_at: string          ◀── ISO дата              │
│  delivery_address: string                               │
│  phone?: string                                         │
│  items: OrderItem[]          ◀── С frozen_price!       │
└─────────────────────────────────────────────────────────┘
```

> 🔥 **Концепция Frozen Price (замороженная цена)**
> 
> ```
> День 1:                          День 2:
> ┌─────────────────────┐          ┌─────────────────────┐
> │ Товар: Портальная   │          │ Товар: Портальная   │
> │ пушка               │          │ пушка               │
> │ Цена: 500 шмеклей   │ ───▶     │ Цена: 600 шмеклей   │
> └─────────────────────┘          └─────────────────────┘
>         │                                  │
>         ▼                                  │
> ┌─────────────────────┐                    │
> │ Заказ #42           │                    │
> │ frozen_price: 500   │ ◀── Не изменится! │
> └─────────────────────┘                    
> ```
> 
> Клиент купил по 500 — в истории заказа навсегда останется 500.
> Даже если товар подорожал до 1000.

### 🔧 Методы cartApi

| Метод | HTTP | Эндпоинт | Описание |
|-------|------|----------|----------|
| `get()` | GET | `/cart/` | Получить текущую корзину |
| `addItem(data)` | POST | `/cart/items` | Добавить товар |
| `updateQuantity(id, data)` | PATCH | `/cart/items/{id}` | Изменить количество |
| `removeItem(id)` | DELETE | `/cart/items/{id}` | Удалить товар |
| `merge(data)` | POST | `/cart/merge` | **Слить корзины** ⭐ |

### ⭐ Метод merge — ключевой для синхронизации

```
┌─────────────────────────────────────────────────────────┐
│                    MERGE (слияние)                      │
├─────────────────────────────────────────────────────────┤
│                                                         │
│  localStorage:              Сервер:                     │
│  ┌───────────────┐          ┌───────────────┐          │
│  │ Товар A: 2 шт │          │ Товар A: 1 шт │          │
│  │ Товар B: 1 шт │          │ Товар C: 3 шт │          │
│  └───────────────┘          └───────────────┘          │
│         │                          │                    │
│         └───────────┬──────────────┘                    │
│                     ▼                                   │
│              ┌─────────────┐                            │
│              │ cartApi     │                            │
│              │ .merge()    │                            │
│              └──────┬──────┘                            │
│                     ▼                                   │
│         ┌───────────────────────┐                       │
│         │ Результат на сервере: │                       │
│         │ Товар A: 3 шт (2+1)   │ ◀── Количество       │
│         │ Товар B: 1 шт         │     суммируется!     │
│         │ Товар C: 3 шт         │                       │
│         └───────────────────────┘                       │
│                                                         │
└─────────────────────────────────────────────────────────┘
```

> 💡 **Upsert = Update + Insert**
> 
> Бэкенд делает "умное" добавление:
> - Если товар уже есть → увеличивает количество
> - Если товара нет → добавляет новый
> 
> Ничего не теряется!

### 🔐 Авторизованные запросы

Все запросы к корзине и заказам требуют токен:

```
┌─────────────────────────────────────────────────────────┐
│                  authorizedFetch()                      │
├─────────────────────────────────────────────────────────┤
│                                                         │
│  1. Берём токен из localStorage                         │
│     │                                                   │
│     ▼                                                   │
│  2. Добавляем заголовок:                                │
│     Authorization: "Bearer eyJhbGciOi..."               │
│     │                                                   │
│     ▼                                                   │
│  3. Отправляем запрос                                   │
│     │                                                   │
│     ├── 200 OK → Возвращаем данные                      │
│     │                                                   │
│     └── 401 Unauthorized → Бросаем ошибку               │
│         "Сессия истекла"                                │
│                                                         │
└─────────────────────────────────────────────────────────┘
```

---

## Коммит 2: Гибридная логика корзины

### 🎯 Цель
Сделать хук `useCart` "умным" — он сам решает, куда сохранять данные.

### 🧠 Паттерн Facade (Фасад)

```
┌─────────────────────────────────────────────────────────┐
│                     КОМПОНЕНТЫ                          │
│  ┌──────────┐  ┌──────────┐  ┌──────────┐               │
│  │ProductCard│  │CartPage  │  │Header    │               │
│  └─────┬────┘  └────┬─────┘  └────┬─────┘               │
│        │            │             │                      │
│        └────────────┼─────────────┘                      │
│                     │                                    │
│                     ▼                                    │
│         ┌───────────────────────┐                        │
│         │       useCart         │ ◀── ФАСАД             │
│         │   (единый интерфейс)  │                        │
│         └───────────┬───────────┘                        │
│                     │                                    │
│    ┌────────────────┼────────────────┐                   │
│    │                │                │                   │
│    ▼                ▼                ▼                   │
│ ┌──────┐      ┌───────────┐    ┌──────────┐             │
│ │useAuth│     │localStorage│    │ cartApi  │             │
│ └──────┘      └───────────┘    └──────────┘             │
│                                                          │
└─────────────────────────────────────────────────────────┘

Компоненты НЕ ЗНАЮТ о сложности под капотом!
Для них есть только: addToCart(), removeFromCart(), items
```

### 🔄 Структура CartItem

```
// Локальная версия (для UI и localStorage)
┌─────────────────────────────────────────────────────────┐
│                      CartItem                           │
├─────────────────────────────────────────────────────────┤
│  product: Product       ◀── Полные данные товара       │
│  quantity: number       ◀── Количество                 │
│  serverItemId?: number  ◀── ID на сервере (если есть)  │
└─────────────────────────────────────────────────────────┘

Зачем serverItemId?
При обновлении/удалении нужно знать ID позиции на сервере!

PATCH /cart/items/42   ◀── Вот этот 42 и есть serverItemId
```

### 📊 Логика addToCart

```
┌─────────────────────────────────────────────────────────┐
│                    addToCart(product)                   │
├─────────────────────────────────────────────────────────┤
│                                                         │
│                    ┌──────────────┐                     │
│                    │  user есть?  │                     │
│                    └──────┬───────┘                     │
│                           │                             │
│              ┌────────────┴────────────┐                │
│              │                         │                │
│              ▼ Да                      ▼ Нет            │
│    ┌─────────────────────┐   ┌─────────────────────┐    │
│    │ await cartApi       │   │ Читаем из           │    │
│    │   .addItem({        │   │ localStorage        │    │
│    │     product_id,     │   │         │           │    │
│    │     quantity: 1     │   │         ▼           │    │
│    │   })                │   │ Добавляем/увеличиваем   │
│    └─────────┬───────────┘   │ количество          │    │
│              │               │         │           │    │
│              ▼               │         ▼           │    │
│    ┌─────────────────────┐   │ Сохраняем обратно   │    │
│    │ Получаем ответ с    │   │ в localStorage      │    │
│    │ serverItemId        │   └─────────────────────┘    │
│    └─────────┬───────────┘             │                │
│              │                         │                │
│              └────────────┬────────────┘                │
│                           │                             │
│                           ▼                             │
│                  ┌─────────────────┐                    │
│                  │ setItems(...)   │                    │
│                  │ UI мгновенно    │                    │
│                  │ обновляется     │                    │
│                  └─────────────────┘                    │
│                                                         │
└─────────────────────────────────────────────────────────┘
```

### 🔄 Загрузка при смене пользователя

```
useEffect(() => {
  fetchCart();
}, [user]);  // ◀── Реагируем на изменение user

┌─────────────────────────────────────────────────────────┐
│                                                         │
│  user: null → user: {...}    (Вход)                     │
│        │                                                │
│        ▼                                                │
│  fetchCart() → cartApi.get() → Данные с сервера         │
│                                                         │
│  ─────────────────────────────────────────────────────  │
│                                                         │
│  user: {...} → user: null    (Выход)                    │
│        │                                                │
│        ▼                                                │
│  fetchCart() → loadFromLocalStorage() → Локальные данные│
│                                                         │
└─────────────────────────────────────────────────────────┘
```

### ⚠️ Важно: Порядок провайдеров

```tsx
// ❌ НЕПРАВИЛЬНО — CartProvider не имеет доступа к useAuth
<CartProvider>
  <AuthProvider>
    <App />
  </AuthProvider>
</CartProvider>

// ✅ ПРАВИЛЬНО — CartProvider внутри, может использовать useAuth
<AuthProvider>
  <CartProvider>
    <App />
  </CartProvider>
</AuthProvider>
```

```
┌───────────────────────────────────────┐
│            AuthProvider               │
│  ┌───────────────────────────────┐    │
│  │         CartProvider          │    │
│  │  ┌─────────────────────────┐  │    │
│  │  │                         │  │    │
│  │  │  useAuth() работает! ✅ │  │    │
│  │  │                         │  │    │
│  │  └─────────────────────────┘  │    │
│  └───────────────────────────────┘    │
└───────────────────────────────────────┘
```

---

## Коммит 3: Синхронизация при входе

### 🎯 Цель
Решить проблему: "Накидал товары как гость, залогинился — корзина пустая!"

### 🔄 Процесс логина с синхронизацией

```
┌─────────────────────────────────────────────────────────┐
│                     handleSubmit()                      │
├─────────────────────────────────────────────────────────┤
│                                                         │
│  1. Отправляем логин/пароль                             │
│     │                                                   │
│     ▼                                                   │
│  ┌─────────────────────────────────────────────┐        │
│  │ const response = await authApi.login(...)   │        │
│  │ // Получаем access_token                    │        │
│  └─────────────────────────────────────────────┘        │
│     │                                                   │
│     ▼                                                   │
│  2. ПЕРЕД сохранением токена — синхронизируем!          │
│     │                                                   │
│     ▼                                                   │
│  ┌─────────────────────────────────────────────┐        │
│  │ await syncLocalCartWithServer(token)        │        │
│  │                                             │        │
│  │   ├── Читаем localStorage                   │        │
│  │   │                                         │        │
│  │   ├── Если пусто → пропускаем               │        │
│  │   │                                         │        │
│  │   ├── Временно ставим токен                 │        │
│  │   │                                         │        │
│  │   ├── cartApi.merge({ items })              │        │
│  │   │                                         │        │
│  │   └── Очищаем localStorage                  │        │
│  └─────────────────────────────────────────────┘        │
│     │                                                   │
│     ▼                                                   │
│  3. Сохраняем токен и получаем профиль                  │
│     │                                                   │
│     ▼                                                   │
│  ┌─────────────────────────────────────────────┐        │
│  │ await login(response.access_token)          │        │
│  └─────────────────────────────────────────────┘        │
│     │                                                   │
│     ▼                                                   │
│  4. Обновляем корзину из контекста                      │
│     │                                                   │
│     ▼                                                   │
│  ┌─────────────────────────────────────────────┐        │
│  │ await refreshCart()                         │        │
│  │ // Загрузит актуальные данные с сервера     │        │
│  └─────────────────────────────────────────────┘        │
│     │                                                   │
│     ▼                                                   │
│  5. Редирект на исходную страницу                       │
│                                                         │
└─────────────────────────────────────────────────────────┘
```

### ⚠️ Почему очищаем localStorage после merge?

```
┌─────────────────────────────────────────────────────────┐
│              БЕЗ ОЧИСТКИ (проблема)                     │
├─────────────────────────────────────────────────────────┤
│                                                         │
│  Логин #1:                                              │
│    localStorage: [A, B] → merge → сервер: [A, B]        │
│                                                         │
│  Выход                                                  │
│                                                         │
│  Логин #2:                                              │
│    localStorage: [A, B] → merge → сервер: [A:2, B:2]   │
│                      ↑                                  │
│                      Дубликаты! 😱                      │
│                                                         │
└─────────────────────────────────────────────────────────┘

┌─────────────────────────────────────────────────────────┐
│              С ОЧИСТКОЙ (правильно)                     │
├─────────────────────────────────────────────────────────┤
│                                                         │
│  Логин #1:                                              │
│    localStorage: [A, B] → merge → сервер: [A, B]        │
│    clearLocalStorageCart() ← очистили!                  │
│                                                         │
│  Выход                                                  │
│                                                         │
│  Логин #2:                                              │
│    localStorage: [] → пропускаем merge                  │
│    Корзина с сервера: [A, B] ✅                         │
│                                                         │
└─────────────────────────────────────────────────────────┘
```

### 💬 UX: Статус синхронизации

Чтобы пользователь понимал, почему вход занимает чуть больше времени:

```
┌─────────────────────────────────────────────────────────┐
│                                                         │
│   ┌─────────────────────────────────────────────────┐   │
│   │            Форма входа                          │   │
│   ├─────────────────────────────────────────────────┤   │
│   │  Email: [________________]                      │   │
│   │  Пароль: [________________]                     │   │
│   │                                                 │   │
│   │  ┌─────────────────────────────────────────┐    │   │
│   │  │ ⏳ Синхронизируем вашу корзину...       │    │   │
│   │  └─────────────────────────────────────────┘    │   │
│   │                                                 │   │
│   │  [ Вход... ]  ← кнопка заблокирована           │   │
│   └─────────────────────────────────────────────────┘   │
│                                                         │
└─────────────────────────────────────────────────────────┘
```

---

## Коммит 4: Оформление заказа

### 🎯 Цель
Реализовать бизнес-цель магазина — продажу!

### 📝 Форма заказа

```
┌─────────────────────────────────────────────────────────┐
│                  Оформление заказа                      │
├─────────────────────────────────────────────────────────┤
│                                                         │
│  Адрес доставки: *                                      │
│  ┌─────────────────────────────────────────────────┐    │
│  │ г. Москва, ул. Пример, д. 1                     │    │
│  │ кв. 42                                          │    │
│  └─────────────────────────────────────────────────┘    │
│                                                         │
│  Телефон для связи:                                     │
│  ┌─────────────────────────────────────────────────┐    │
│  │ +7 (999) 123-45-67                              │    │
│  └─────────────────────────────────────────────────┘    │
│                                                         │
│  ┌─────────────────────────────────────────────────┐    │
│  │ Товаров: 3                                      │    │
│  │ Сумма: 💰 1500.00 шмеклей                       │    │
│  └─────────────────────────────────────────────────┘    │
│                                                         │
│  ┌──────────────┐  ┌────────────────────────────────┐   │
│  │    Отмена    │  │      Подтвердить заказ         │   │
│  └──────────────┘  └────────────────────────────────┘   │
│                                                         │
└─────────────────────────────────────────────────────────┘
```

### 🔄 Процесс оформления

```
┌─────────────────────────────────────────────────────────┐
│                    handleCheckout()                     │
├─────────────────────────────────────────────────────────┤
│                                                         │
│  1. Отправляем данные на сервер                         │
│     │                                                   │
│     ▼                                                   │
│  ┌─────────────────────────────────────────────┐        │
│  │ await ordersApi.create({                    │        │
│  │   delivery_address: "...",                  │        │
│  │   phone: "..."                              │        │
│  │ })                                          │        │
│  └─────────────────────────────────────────────┘        │
│     │                                                   │
│     │  ⚠️ Товары НЕ отправляем!                         │
│     │     Бэкенд сам возьмёт их из корзины              │
│     │                                                   │
│     ▼                                                   │
│  2. Бэкенд:                                             │
│     ├── Создаёт заказ                                   │
│     ├── Копирует товары с frozen_price                  │
│     ├── Очищает корзину                                 │
│     └── Возвращает Order                                │
│     │                                                   │
│     ▼                                                   │
│  3. Фронтенд:                                           │
│     ├── setCreatedOrder(order)  — показываем успех     │
│     └── clearCart()             — синхронизируем UI    │
│                                                         │
└─────────────────────────────────────────────────────────┘
```

### ✅ Экран успеха

```
┌─────────────────────────────────────────────────────────┐
│                                                         │
│           🎉 Заказ успешно оформлен!                    │
│                                                         │
│  ┌─────────────────────────────────────────────────┐    │
│  │ Номер заказа: #42                               │    │
│  │ Сумма: 💰 1500.00 шмеклей                       │    │
│  │ Адрес: г. Москва, ул. Пример, д. 1              │    │
│  │ Статус: ⏳ Ожидает обработки                    │    │
│  └─────────────────────────────────────────────────┘    │
│                                                         │
│  ┌───────────────────┐  ┌────────────────────────────┐  │
│  │ Посмотреть заказы │  │   Продолжить покупки       │  │
│  └───────────────────┘  └────────────────────────────┘  │
│                                                         │
└─────────────────────────────────────────────────────────┘
```

### 🎨 Модальное окно — паттерн

```
┌─────────────────────────────────────────────────────────┐
│              Оверлей (затемнение)                       │
│  onClick={() => setShowCheckoutForm(false)}             │
│                                                         │
│     ┌───────────────────────────────────────────┐       │
│     │           Модальное окно                  │       │
│     │     onClick={(e) => e.stopPropagation()}  │       │
│     │                                           │       │
│     │     Клик внутри НЕ закрывает окно!        │       │
│     └───────────────────────────────────────────┘       │
│                                                         │
│  Клик снаружи (на оверлей) → закрывает                  │
│                                                         │
└─────────────────────────────────────────────────────────┘
```

> 💡 **e.stopPropagation()** — останавливает "всплытие" события.
> Без этого клик на форме "всплыл" бы до оверлея и закрыл окно.

---

## Коммит 5: История заказов

### 🎯 Цель
Дать пользователю уверенность, что его заказ принят и сохранён.

### 📋 Список заказов

```
┌─────────────────────────────────────────────────────────┐
│                    📋 Мои заказы                        │
├─────────────────────────────────────────────────────────┤
│                                                         │
│  ┌─────────────────────────────────────────────────┐    │
│  │ Заказ #42        26 ноября 2025, 15:30          │    │
│  │ ⏳ Ожидает обработки          💰 1500.00 шм.   ▼│    │
│  └─────────────────────────────────────────────────┘    │
│                                                         │
│  ┌─────────────────────────────────────────────────┐    │
│  │ Заказ #41        25 ноября 2025, 10:15          │    │
│  │ 🎉 Доставлен                   💰 800.00 шм.   ▶│    │
│  └─────────────────────────────────────────────────┘    │
│                                                         │
└─────────────────────────────────────────────────────────┘

При клике на заказ — разворачиваются детали (аккордеон):

┌─────────────────────────────────────────────────────────┐
│ Заказ #42        26 ноября 2025, 15:30                  │
│ ⏳ Ожидает обработки              💰 1500.00 шм.   ▲   │
├─────────────────────────────────────────────────────────┤
│ Адрес: г. Москва, ул. Пример, д. 1                      │
│ Телефон: +7 (999) 123-45-67                             │
│                                                         │
│ Состав заказа:                                          │
│ ┌─────────────────────────────────────────────────┐     │
│ │ Портальная пушка      2 × 500.00 = 1000.00 шм. │     │
│ │ Плюмбус               1 × 500.00 = 500.00 шм.  │     │
│ └─────────────────────────────────────────────────┘     │
└─────────────────────────────────────────────────────────┘
```

### 🗓️ Форматирование даты

```
Приходит с сервера (ISO):     Показываем пользователю:
"2025-11-26T15:30:00"    →    "26 ноября 2025, 15:30"

┌─────────────────────────────────────────────────────────┐
│                     formatDate()                        │
├─────────────────────────────────────────────────────────┤
│                                                         │
│  const date = new Date(isoDate);                        │
│                                                         │
│  return date.toLocaleDateString('ru-RU', {              │
│    day: 'numeric',     // 26                            │
│    month: 'long',      // ноября                        │
│    year: 'numeric',    // 2025                          │
│    hour: '2-digit',    // 15                            │
│    minute: '2-digit',  // 30                            │
│  });                                                    │
│                                                         │
└─────────────────────────────────────────────────────────┘
```

### 🏷️ Статусы заказа

```
┌──────────────┬─────────────────────┬───────┐
│    Статус    │      Описание       │ Emoji │
├──────────────┼─────────────────────┼───────┤
│ pending      │ Ожидает обработки   │  ⏳   │
│ confirmed    │ Подтверждён         │  ✅   │
│ shipped      │ Отправлен           │  📦   │
│ delivered    │ Доставлен           │  🎉   │
│ cancelled    │ Отменён             │  ❌   │
└──────────────┴─────────────────────┴───────┘
```

### 🎹 Паттерн Аккордеон

```tsx
const [expandedOrderId, setExpandedOrderId] = useState<number | null>(null);

// При клике — переключаем
const toggleOrderDetails = (orderId: number) => {
  setExpandedOrderId(prev => 
    prev === orderId 
      ? null      // Закрыть, если уже открыт
      : orderId   // Открыть новый
  );
};
```

```
Состояние:                      UI:
expandedOrderId = null      →   Все заказы свёрнуты
expandedOrderId = 42        →   Заказ #42 развёрнут
```

---

## Итоговая архитектура

### ✅ Чек-лист функциональности

| Сценарий | До | После |
|----------|:--:|:-----:|
| Гость добавляет товар | ❌ Память | ✅ localStorage |
| Закрыл вкладку | ❌ Потерял | ✅ Сохранено |
| Вход — товары исчезли | ❌ Да | ✅ Merge |
| Изменить количество (юзер) | ❌ Локально | ✅ Сервер |
| Оформить заказ | ❌ Нет | ✅ ordersApi |
| История заказов | ❌ Нет | ✅ ProfilePage |

### 📁 Изменённые файлы

```
src/
├── types/
│   └── api.ts            ← Новые типы Cart, Order...
├── services/
│   └── api.ts            ← cartApi, ordersApi
├── hooks/
│   └── useCart.tsx       ← Гибридная логика
├── context/
│   └── AuthContext.tsx   ← Без изменений
├── components/
│   ├── LoginPage.tsx     ← Merge при логине
│   ├── CartPage.tsx      ← Форма заказа
│   ├── ProfilePage.tsx   ← История заказов
│   └── ProductCard.tsx   ← Async addToCart
├── App.tsx               ← Порядок провайдеров
└── main.tsx              ← Упрощён
```

### 🔗 Связи между коммитами

```
┌─────────────┐
│ Коммит #1   │ API слой (типы + методы)
│ (фундамент) │
└──────┬──────┘
       │
       ▼
┌─────────────┐
│ Коммит #2   │ Гибридный useCart
│ (ядро)      │ использует cartApi
└──────┬──────┘
       │
       ├────────────────────┐
       │                    │
       ▼                    ▼
┌─────────────┐      ┌─────────────┐
│ Коммит #3   │      │ Коммит #4   │
│ Merge       │      │ Заказы      │
│ при логине  │      │ ordersApi   │
└─────────────┘      └──────┬──────┘
                            │
                            ▼
                     ┌─────────────┐
                     │ Коммит #5   │
                     │ История     │
                     │ заказов     │
                     └─────────────┘
```

### 💡 Ключевые принципы

1. **Единый источник правды** — сервер считает total_price и хранит данные
2. **Facade (Фасад)** — useCart скрывает сложность от компонентов
3. **Оптимистичный UI** — сначала обновляем интерфейс, потом ждём ответ
4. **Graceful Degradation** — если API недоступен, работаем с localStorage
5. **Frozen Price** — защита от изменения цен после покупки

---

## 🔧 Известные проблемы и решения

### Ошибка транзакции на бэкенде

Если видите `A transaction is already begun on this Session` — это проблема в FastAPI.
В `order_crud.py` нужно убрать `async with session.begin()`, так как сессия уже в транзакции.

### Корзина для гостей

Можно открыть `/cart` для всех (убрать из ProtectedRoute), добавив проверку авторизации только при оформлении заказа.

---

*Конспект создан: 26 ноября 2025*
